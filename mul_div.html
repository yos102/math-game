<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×¤×œ ×•×—×™×œ×•×§ - ××§×“××™×™×ª ×”××ª××˜×™×§×”</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #fffaf0; text-align: center; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .container { 
            max-width: 500px; 
            width: 90%;
            margin: 20px auto; 
            background: white; 
            padding: 25px; 
            border-radius: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            position: relative; 
        }
        
        .math-row { 
            font-size: 3.5rem; 
            margin: 20px 0; 
            direction: ltr; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .ans-input { width: 140px; font-size: 2.5rem; text-align: center; border: 3px solid #e2e8f0; border-radius: 15px; outline: none; transition: 0.3s; background: #f8fafc; }
        .ans-input:focus { border-color: #ed8936; background: white; box-shadow: 0 0 15px rgba(237,137,54,0.2); }

        .btn { padding: 15px; border-radius: 12px; border: none; cursor: pointer; width: 100%; margin: 8px 0; font-weight: bold; font-size: 1.1rem; transition: 0.2s; }
        
        .btn-check { 
            background: #48bb78; 
            color: white; 
            box-shadow: 0 5px 0 #2f855a;
            font-size: 1.3rem;
            margin-top: 15px;
        }
        .btn-check:active { transform: translateY(3px); box-shadow: 0 2px 0 #2f855a; }

        .grid-ops { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .btn-op { padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; background: white; font-weight: bold; transition: 0.2s; }
        .btn-op.selected { border-color: #ed8936; background: #fff3e0; color: #c05621; }

        .grid-targets { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .target-btn { padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; background: white; font-weight: bold; }
        .target-btn.active { background: #ed8936; color: white; border-color: #c05621; }

        .helper-group { display: flex; gap: 12px; margin-top: 10px; }
        .btn-helper { background: #f7fafc; border: 2px solid #cbd5e0; color: #718096; font-size: 0.95rem; padding: 10px; flex: 1; border-radius: 12px; cursor: pointer; font-weight: bold; }

        .hidden { display: none !important; }

        /* ×œ×•×— ×›×¤×œ ××œ× - ××•×“××œ */
        #table-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; padding: 10px; align-items: center; justify-content: center; }
        .table-card { background: white; padding: 15px; border-radius: 20px; width: 95%; max-width: 550px; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .table-wrapper { overflow-x: auto; margin-top: 10px; border-radius: 10px; border: 1px solid #eee; touch-action: pan-x; }
        .multiplication-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; direction: ltr; }
        .multiplication-table th, .multiplication-table td { border: 1px solid #eee; padding: 12px 2px; text-align: center; transition: 0.1s; }
        
        /* ×›×•×ª×¨×•×ª ×“×‘×™×§×•×ª */
        .multiplication-table th { background: #edf2f7; color: #ed8936; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        .multiplication-table td.header-col { background: #edf2f7; color: #ed8936; font-weight: bold; position: sticky; left: 0; z-index: 1; }

        /* ××¤×§×˜ ×¨×™×—×•×£ ×¢×›×‘×¨ */
        @media (hover: hover) {
            .multiplication-table tr:hover td { background: #f7fafc; }
            .multiplication-table td:hover { background: #ed8936 !important; color: white; transform: scale(1.1); font-weight: bold; z-index: 5; }
        }

        /* ××—×œ×§×ª ×”×“×’×©×” ×œ××’×¢ */
        .touch-highlight { background: #ed8936 !important; color: white !important; font-weight: bold; transform: scale(1.1); }
        .multiplication-table td.highlight { background: #fff3e0; border: 2px solid #ed8936; font-weight: bold; color: #c05621; }

        /* ×¢×™×¦×•×‘ ×˜×™×•×˜×” */
        .draft-btn-container { position: absolute; top: 20px; right: 20px; width: 45px; height: 45px; border-radius: 12px; background: #ed8936; color: white; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        #draft-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; padding: 15px; flex-direction: column; align-items: center; justify-content: center; }
        .draft-card { background: white; width: 100%; max-width: 600px; height: 80vh; border-radius: 20px; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .draft-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; background: #f8fafc; }
        #draft-canvas { flex-grow: 1; cursor: crosshair; touch-action: none; background: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <button class="draft-btn-container hidden" id="draft-trigger" onclick="toggleDraft()">ğŸ“</button>

        <div id="setup">
            <h2 style="color: #2d3748;">×›×¤×œ ×•×—×™×œ×•×§ ğŸš€</h2>
            
            <div class="grid-ops">
                <button class="btn-op selected" onclick="setOp('mul', this)">âœ–ï¸ ×›×¤×œ</button>
                <button class="btn-op" onclick="setOp('div', this)">â— ×—×™×œ×•×§</button>
                <button class="btn-op" onclick="setOp('both', this)">ğŸ”„ ×©× ×™×”×</button>
            </div>

            <p style="font-weight: bold; color: #4a5568;">×‘×—×¨ ×›×¤×•×œ×•×ª ×œ×ª×¨×’×•×œ (××¤×©×¨ ×›××”):</p>
            <div id="targets" class="grid-targets"></div>

            <button class="btn" style="background:#ed8936; color:white; box-shadow: 0 4px 0 #c05621; margin-top:20px;" onclick="start()">×”×ª×—×œ ×œ×œ××•×“! âœ¨</button>
            <br><br>
            <a href="./" style="color:#718096; text-decoration:none; font-weight:bold;">ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜</a>
        </div>

        <div id="game" class="hidden">
            <button class="btn-helper" style="background: #fff3e0; color: #ed8936; border-color: #ed8936; margin-bottom: 15px;" onclick="toggleTableModal()">ğŸ“Š ×”×¦×’ ×œ×•×— ×›×¤×œ ××œ×</button>
            
            <div id="quest" class="math-row"></div>
            <input type="number" id="ans" class="ans-input" inputmode="numeric" placeholder="?"><br>
            
            <button class="btn btn-check" onclick="check()">×‘×“×™×§×” âœ…</button>
            
            <div class="helper-group">
                <button class="btn btn-helper" onclick="revealSolution()">ğŸ’¡ ×¤×ª×¨×•×Ÿ</button>
                <button class="btn btn-helper" onclick="next()">â­ï¸ ×“×œ×’</button>
            </div>

            <p id="feedback" style="font-size: 1.6rem; min-height: 2.5rem; margin: 15px 0; font-weight: bold;"></p>
            
            <button class="btn" style="background: transparent; color: #a0aec0; font-size: 0.9rem; width: auto; text-decoration: underline;" onclick="location.reload()">×©×™× ×•×™ ×”×’×“×¨×•×ª</button>
        </div>
    </div>

    <div id="table-modal">
        <div class="table-card">
            <h3 style="margin: 0 0 5px 0; color: #2d3748;">×œ×•×— ×”×›×¤×œ</h3>
            <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">(×’×¨×•×¨ ××ª ×”××¦×‘×¢ ×¢×œ ×”××¡×¤×¨×™× ×œ×”×“×’×©×”)</p>
            <div class="table-wrapper" id="table-scroll-area">
                <table id="full-multiplication-table" class="multiplication-table"></table>
            </div>
            <button class="btn" style="background:#4a90e2; color:white; margin-top:15px;" onclick="toggleTableModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <div id="draft-modal">
        <div class="draft-card">
            <div class="draft-header">
                <span style="font-weight: bold;">ğŸ–ï¸ ×˜×™×•×˜×”</span>
                <div style="display:flex; gap:8px;">
                    <button onclick="undoDraft()" style="background:#cbd5e0; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">â†©ï¸</button>
                    <button onclick="clearDraft()" style="background:#f56565; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">××—×§</button>
                    <button onclick="toggleDraft()" style="background:#4a90e2; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">×¡×’×•×¨</button>
                </div>
            </div>
            <canvas id="draft-canvas"></canvas>
        </div>
    </div>

    <script>
        let op = 'mul', selectedTables = [2], currentAns, currentTable, currentN2;
        let undoStack = [];

        function buildFullTable() {
            const table = document.getElementById('full-multiplication-table');
            let html = '<thead><tr><th>Ã—</th>';
            for (let i = 1; i <= 10; i++) html += `<th>${i}</th>`;
            html += '</tr></thead><tbody>';

            for (let i = 1; i <= 10; i++) {
                html += `<tr><td class="header-col">${i}</td>`;
                for (let j = 1; j <= 10; j++) {
                    html += `<td class="cell" id="cell-${i}-${j}">${i * j}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody>';
            table.innerHTML = html;
            
            // ×”×•×¡×¤×ª ×œ×•×’×™×§×ª ×”××’×¢
            addTouchListeners();
        }

        function addTouchListeners() {
            const container = document.getElementById('table-scroll-area');
            
            const handleTouch = (e) => {
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                
                // ×”×¡×¨×ª ×”×“×’×©×” ×§×•×“××ª
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('touch-highlight'));
                
                if (target && target.classList.contains('cell')) {
                    target.classList.add('touch-highlight');
                }
            };

            container.addEventListener('touchmove', handleTouch, {passive: true});
            container.addEventListener('touchstart', handleTouch, {passive: true});
            container.addEventListener('touchend', () => {
                // ××•×¤×¦×™×•× ×œ×™: ×”×¡×¨×ª ×”×”×“×’×©×” ×›×©×¢×•×–×‘×™×. ×× ×¨×•×¦×™× ×©×ª×©××¨, ××¤×©×¨ ×œ××—×•×§ ×©×•×¨×” ×–×•.
                setTimeout(() => {
                    document.querySelectorAll('.cell').forEach(c => c.classList.remove('touch-highlight'));
                }, 1000);
            });
        }

        buildFullTable();

        const tg = document.getElementById('targets');
        for(let i=2; i<=10; i++) {
            const activeClass = i === 2 ? 'active' : '';
            tg.innerHTML += `<button onclick="toggleTable(${i}, this)" class="target-btn ${activeClass}">${i}</button>`;
        }

        function toggleTable(num, btn) {
            if (selectedTables.includes(num)) {
                if (selectedTables.length > 1) {
                    selectedTables = selectedTables.filter(n => n !== num);
                    btn.classList.remove('active');
                }
            } else {
                selectedTables.push(num);
                btn.classList.add('active');
            }
        }

        function toggleTableModal() {
            const modal = document.getElementById('table-modal');
            const isOpening = modal.style.display !== 'flex';
            modal.style.display = isOpening ? 'flex' : 'none';
            
            if (isOpening) {
                document.querySelectorAll('.multiplication-table td').forEach(td => td.classList.remove('highlight'));
                const cell = document.getElementById(`cell-${currentTable}-${currentN2}`) || document.getElementById(`cell-${currentN2}-${currentTable}`);
                if (cell) cell.classList.add('highlight');
            }
        }

        function setOp(o, b) {
            op = o;
            document.querySelectorAll('.btn-op').forEach(btn => btn.classList.remove('selected'));
            b.classList.add('selected');
        }

        function start() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('draft-trigger').classList.remove('hidden');
            next();
        }

        function next() {
            currentTable = selectedTables[Math.floor(Math.random() * selectedTables.length)];
            currentN2 = Math.floor(Math.random() * 10) + 1;
            const currentOp = (op === 'both') ? (Math.random() > 0.5 ? 'mul' : 'div') : op;
            
            if(currentOp === 'mul') {
                currentAns = currentTable * currentN2;
                document.getElementById('quest').innerHTML = `<span>${currentN2}</span> <span>Ã—</span> <span>${currentTable}</span> <span>=</span>`;
            } else {
                currentAns = currentN2;
                const product = currentTable * currentN2;
                document.getElementById('quest').innerHTML = `<span>${product}</span> <span>Ã·</span> <span>${currentTable}</span> <span>=</span>`;
            }
            
            document.getElementById('ans').value = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('ans').focus();
        }

        function check() {
            let val = parseInt(document.getElementById('ans').value);
            if(val === currentAns) {
                document.getElementById('feedback').innerHTML = "<span style='color:#48bb78'>× ×›×•×Ÿ ×××•×“! ğŸŒŸ</span>";
                setTimeout(next, 1200);
            } else if (!isNaN(val)) {
                document.getElementById('feedback').innerHTML = "<span style='color:#f56565'>× ×¡×” ×©×•×‘ ğŸ¤”</span>";
            }
        }

        function revealSolution() {
            document.getElementById('ans').value = currentAns;
            document.getElementById('feedback').innerHTML = `<span style='color:#718096'>×”×ª×©×•×‘×” ×”×™× ${currentAns}</span>`;
        }

        const canvas = document.getElementById('draft-canvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function setupCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineCap = 'round'; ctx.lineWidth = 4; ctx.strokeStyle = '#2d3748';
            saveState();
        }

        function saveState() {
            if (undoStack.length > 20) undoStack.shift();
            undoStack.push(canvas.toDataURL());
        }

        function undoDraft() {
            if (undoStack.length > 1) {
                undoStack.pop();
                let img = new Image();
                img.src = undoStack[undoStack.length - 1];
                img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); };
            }
        }

        function toggleDraft() {
            const modal = document.getElementById('draft-modal');
            const isOpen = modal.style.display === 'flex';
            modal.style.display = isOpen ? 'none' : 'flex';
            if (!isOpen) setTimeout(setupCanvas, 10);
        }

        function clearDraft() { ctx.clearRect(0, 0, canvas.width, canvas.height); saveState(); }
        
        function startPos(e) { painting = true; draw(e); }
        function endPos() { if (painting) saveState(); painting = false; ctx.beginPath(); }
        function draw(e) {
            if (!painting) return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            ctx.lineTo(clientX - rect.left, clientY - rect.top);
            ctx.stroke(); ctx.beginPath(); ctx.moveTo(clientX - rect.left, clientY - rect.top);
        }

        canvas.addEventListener('mousedown', startPos);
        canvas.addEventListener('mouseup', endPos);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPos(e); }, {passive:false});
        canvas.addEventListener('touchend', endPos);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive:false});

        window.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') check();
            if(e.key === 'Escape') {
                document.getElementById('draft-modal').style.display = 'none';
                document.getElementById('table-modal').style.display = 'none';
            }
        });
    </script>
</body>
</html>
