<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××§×“××™×™×ª ×”××ª××˜×™×§×” - ×’×¨×¡×ª ×”×˜×™×•×˜×” ×”××§×¦×•×¢×™×ª</title>
    <style>
        :root {
            --primary: #4a90e2; --bg: #f7fafc; --card-bg: #ffffff; --text: #1a202c; --accent: #f6e05e;
            --sub-color: #f56565; --mul-color: #ed8936; --story-color: #48bb78;
        }
        body.dark-mode { --bg: #1a202c; --card-bg: #2d3748; --text: #f7fafc; }
        body.kids-mode { --bg: #fff5f7; --primary: #ff6b6b; --text: #4a5568; }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; transition: 0.3s; overflow-x: hidden; touch-action: manipulation; }
        .container { max-width: 600px; width: 92%; background: var(--card-bg); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; text-align: center; margin: 15px auto; }
        .hidden { display: none !important; }
        
        /* ×”×ª×§×“××•×ª */
        .stats-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 15px; margin-bottom: 10px; font-weight: bold; }
        .progress-container { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: 0.5s; }

        .btn { padding: 15px; border-radius: 15px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin: 8px 0; color: white; transition: 0.2s; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: var(--sub-color); }
        .btn-orange { background: var(--mul-color); }
        .btn-gray { background: #edf2f7; color: #4a5568; }

        /* ×œ×•×— ×˜×™×•×˜×” ××©×•×¤×¨ */
        #sketchpad-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #sketch-canvas { background: white; border-radius: 15px; cursor: crosshair; touch-action: none; box-shadow: 0 0 25px rgba(255,255,255,0.3); }
        .sketch-tools { margin-top: 15px; display: flex; gap: 10px; width: 95%; max-width: 500px; }
        .tool-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; }

        /* ×’×¨×™×“ ×××•× ×š */
        .vertical-math { display: grid; grid-template-columns: 40px repeat(4, 50px); gap: 5px; justify-content: center; align-items: center; margin: 20px auto; direction: ltr; }
        .digit { font-family: 'Courier New', monospace; font-size: 2.2rem; font-weight: bold; }
        .ans-input { width: 45px; height: 55px; border: 3px solid var(--primary); border-radius: 8px; font-size: 1.8rem; text-align: center; background: #ebf8ff; }
        .line { grid-column: 1 / span 5; height: 3px; background: #333; }
    </style>
</head>
<body class="kids-mode">

    <div class="container">
        <div class="stats-bar">
            <span>×¨××”: <span id="lvl-display">1</span></span>
            <span>XP: <span id="xp-display">0</span></span>
        </div>
        <div class="progress-container"><div id="progress-bar" class="progress-fill"></div></div>

        <div id="page-lobby">
            <h1>××§×“××™×™×ª ×”×—×©×‘×•×Ÿ ğŸ“</h1>
            <button class="btn btn-blue" onclick="showPage('setup-add')">â• ×—×™×‘×•×¨ ×•×—×™×¡×•×¨</button>
            <button class="btn btn-orange" onclick="showPage('setup-mul')">âœ–ï¸ ×›×¤×œ ×•×—×™×œ×•×§</button>
            <button class="btn btn-red" style="background:#9f7aea" onclick="showPage('setup-v')">ğŸ“ ×—×©×‘×•×Ÿ ×××•× ×š</button>
            <button class="btn btn-gray" onclick="showPage('settings')">âš™ï¸ ×”×’×“×¨×•×ª</button>
        </div>

        <div id="page-setup-v" class="hidden">
            <h2>×‘×—×¨ ×¡×•×’ ×××•× ×š:</h2>
            <button class="btn btn-blue" onclick="vType='add'; startMode('vertical')">×—×™×‘×•×¨ ×××•× ×š</button>
            <button class="btn btn-red" onclick="vType='sub'; startMode('vertical')">×—×™×¡×•×¨ ×××•× ×š</button>
            <button class="btn btn-orange" onclick="vType='mul'; mulLevel='single'; startMode('vertical')">×›×¤×œ (×—×“-×¡×¤×¨×ª×™)</button>
            <button class="btn btn-orange" style="border: 2px solid #333" onclick="vType='mul'; mulLevel='double'; startMode('vertical')">×›×¤×œ (×“×•-×¡×¤×¨×ª×™)</button>
            <button class="btn btn-gray" onclick="showPage('lobby')">×—×–×¨×”</button>
        </div>

        <div id="page-game" class="hidden">
            <div style="display:flex; justify-content: space-between; margin-bottom: 10px;">
                <button style="background:gold; border-radius:50%; width:45px; height:45px; border:none; cursor:pointer;" onclick="alert('×”×©×ª××© ×‘×˜×™×•×˜×” âœï¸ ×œ×—×™×©×•×‘×™×!')">ğŸ’¡</button>
                <button style="background:#48bb78; color:white; border-radius:50%; width:45px; height:45px; border:none; cursor:pointer; font-size:1.2rem;" onclick="openSketchpad()">âœï¸</button>
            </div>
            <div id="game-content"></div>
            <button class="btn btn-blue" onclick="check()">×‘×“×™×§×” âœ…</button>
            <div id="feedback" style="margin-top:10px; font-weight:bold;"></div>
            <button class="btn btn-gray" onclick="showPage('lobby')">×¡×™×•×</button>
        </div>
    </div>

    <div id="sketchpad-container" class="hidden">
        <h3 style="color:white; margin: 10px;">×˜×™×•×˜×” ×œ×—×™×©×•×‘×™× ğŸ“</h3>
        <canvas id="sketch-canvas"></canvas>
        <div class="sketch-tools">
            <button class="tool-btn" style="background:#f6e05e; color:#333" onclick="undoLast()">â†©ï¸ ×‘×˜×œ ×§×• (Undo)</button>
            <button class="tool-btn" style="background:#e53e3e" onclick="clearSketch()">ğŸ—‘ï¸ ××—×§ ×”×›×œ</button>
            <button class="tool-btn" style="background:#4a90e2" onclick="closeSketchpad()">×—×–×•×¨ ×œ×ª×¨×’×™×œ â”</button>
        </div>
    </div>

<script>
    let stats = JSON.parse(localStorage.getItem('math_pro_v14') || '{"xp":0, "lvl":1}');
    let currentMode = '', vType = 'add', mulLevel = 'single', currentQ = {};
    
    // ×”×’×“×¨×•×ª ×§× ×‘×¡ ×•-Undo
    const canvas = document.getElementById('sketch-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let paths = []; // ×©××™×¨×ª × ×ª×™×‘×™ ×”×¦×™×•×¨

    function openSketchpad() {
        document.getElementById('sketchpad-container').classList.remove('hidden');
        canvas.width = window.innerWidth * 0.95;
        canvas.height = window.innerHeight * 0.7;
        redrawCanvas();
    }

    function closeSketchpad() { document.getElementById('sketchpad-container').classList.add('hidden'); }

    function startDraw(e) {
        drawing = true;
        const pos = getPos(e);
        paths.push([{ x: pos.x, y: pos.y }]);
    }

    function draw(e) {
        if (!drawing) return;
        const pos = getPos(e);
        const currentPath = paths[paths.length - 1];
        currentPath.push({ x: pos.x, y: pos.y });
        redrawCanvas();
    }

    function endDraw() { drawing = false; }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';

        paths.forEach(path => {
            if (path.length < 2) return;
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
        });
    }

    function undoLast() {
        paths.pop();
        redrawCanvas();
    }

    function clearSketch() {
        paths = [];
        redrawCanvas();
    }

    // ××™×¨×•×¢×™ ××’×¢ ×•×¢×›×‘×¨
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', endDraw);

    // ×œ×•×’×™×§×ª ××©×—×§
    function showPage(id) {
        document.querySelectorAll('.container > div').forEach(d => { if(d.id.startsWith('page')) d.classList.add('hidden'); });
        document.getElementById('page-' + id).classList.remove('hidden');
    }

    function startMode(m) { currentMode = m; showPage('game'); nextQ(); }

    function nextQ() {
        const content = document.getElementById('game-content');
        let n1, n2;
        if(vType === 'mul') {
            n1 = Math.floor(Math.random()*90)+10; 
            n2 = (mulLevel === 'single') ? Math.floor(Math.random()*8)+2 : Math.floor(Math.random()*80)+11;
        } else {
            n1 = Math.floor(Math.random()*800)+100; n2 = Math.floor(Math.random()*800)+10;
            if(vType==='sub' && n1 < n2) [n1, n2] = [n2, n1];
        }
        currentQ = { n1, n2, ans: vType==='add'?n1+n2 : (vType==='sub'?n1-n2 : n1*n2) };
        content.innerHTML = `<div class="vertical-math"><div></div><input type="text" class="ans-input" style="height:30px; border:1px dashed #ccc;"><input type="text" class="ans-input" style="height:30px; border:1px dashed #ccc;"><div></div><div></div><div></div>${dg(n1)}<div class="operator">${vType==='add'?'+':(vType==='sub'?'-':'Ã—')}</div>${dg(n2)}<div class="line"></div><div></div><input type="number" class="ans-input" id="va3"><input type="number" class="ans-input" id="va2"><input type="number" class="ans-input" id="va1"><input type="number" class="ans-input" id="va0"></div>`;
    }

    function dg(n) { return [...n.toString().padStart(4, ' ')].map(c => `<div class="digit">${c===' '?'':c}</div>`).join(''); }

    function check() {
        let val = parseInt([3,2,1,0].map(i => document.getElementById('va'+i).value || '').reverse().join(''));
        if(val === currentQ.ans) {
            stats.xp += 20; if(stats.xp % 100 === 0) stats.lvl++;
            updateUI();
            document.getElementById('feedback').innerHTML = "<span style='color:green'>×›×œ ×”×›×‘×•×“! +20 XP âœ¨</span>";
            setTimeout(nextQ, 1500);
        } else {
            document.getElementById('feedback').innerHTML = "<span style='color:red'>× ×¡×” ×©×•×‘!</span>";
        }
    }

    function updateUI() {
        document.getElementById('xp-display').innerText = stats.xp;
        document.getElementById('lvl-display').innerText = stats.lvl;
        document.getElementById('progress-bar').style.width = (stats.xp % 100) + "%";
        localStorage.setItem('math_pro_v14', JSON.stringify(stats));
    }

    function showPage(id) {
        document.querySelectorAll('.container > div').forEach(d => { if(d.id.startsWith('page')) d.classList.add('hidden'); });
        document.getElementById('page-' + id).classList.remove('hidden');
    }

    updateUI();
</script>
</body>
</html>
